From 5eb921ce8ae364c2b91f051413f54d0b10a6c3b3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Markku=20Ahvenj=C3=A4rvi?= <mankku@gmail.com>
Date: Fri, 12 Dec 2025 11:11:01 +0200
Subject: [PATCH] Add support for pKVM
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Markku Ahvenj√§rvi <mankku@gmail.com>
---
 configs/devices/i386-softmmu/default.mak |  1 +
 hw/i386/Kconfig                          |  5 ++
 qapi/qom.json                            |  1 +
 qemu-options.hx                          |  4 +
 target/i386/meson.build                  |  2 +
 target/i386/pkvm.c                       | 98 ++++++++++++++++++++++++
 target/i386/pkvm.h                       | 22 ++++++
 7 files changed, 133 insertions(+)
 create mode 100644 target/i386/pkvm.c
 create mode 100644 target/i386/pkvm.h

diff --git a/configs/devices/i386-softmmu/default.mak b/configs/devices/i386-softmmu/default.mak
index bc0479a7e0a3..680ce39a66c5 100644
--- a/configs/devices/i386-softmmu/default.mak
+++ b/configs/devices/i386-softmmu/default.mak
@@ -14,6 +14,7 @@
 #CONFIG_PCI_IPMI_BT=n
 #CONFIG_IPMI_SSIF=n
 #CONFIG_PCI_DEVICES=n
+#CONFIG_PKVM=n
 #CONFIG_PVPANIC=n
 #CONFIG_QXL=n
 #CONFIG_SEV=n
diff --git a/hw/i386/Kconfig b/hw/i386/Kconfig
index 3a0e2b8ebbb6..60e94e5579c8 100644
--- a/hw/i386/Kconfig
+++ b/hw/i386/Kconfig
@@ -30,6 +30,7 @@ config PC
     imply PVPANIC_ISA
     imply QXL
     imply SEV
+    imply PKVM
     imply SGX
     imply TDX
     imply TEST_DEVICES
@@ -170,3 +171,7 @@ config XEN_EMU
     bool
     default y
     depends on KVM && I386
+
+config PKVM
+    bool
+    depends on KVM
diff --git a/qapi/qom.json b/qapi/qom.json
index 830cb2ffe781..405866a74913 100644
--- a/qapi/qom.json
+++ b/qapi/qom.json
@@ -1221,6 +1221,7 @@
     { 'name': 'memory-backend-shm',
       'if': 'CONFIG_POSIX' },
     'pef-guest',
+    'pkvm-guest',
     { 'name': 'pr-manager-helper',
       'if': 'CONFIG_LINUX' },
     'qtest',
diff --git a/qemu-options.hx b/qemu-options.hx
index ab23f14d2178..f50563f74ef4 100644
--- a/qemu-options.hx
+++ b/qemu-options.hx
@@ -6206,6 +6206,10 @@ SRST
                  -machine ...,igvm-cfg=igvm0 \\
                  .....
 
+    ``-object pkvm-guest,id=id``
+        Create a pKVM guest object, which can be used to safeguard the guest
+	from the host.
+
     ``-object authz-simple,id=id,identity=string``
         Create an authorization object that will control access to
         network services.
diff --git a/target/i386/meson.build b/target/i386/meson.build
index 092af34e2d85..3958d218b63a 100644
--- a/target/i386/meson.build
+++ b/target/i386/meson.build
@@ -7,6 +7,7 @@ i386_ss.add(files(
   'cpu-dump.c',
 ))
 i386_ss.add(when: 'CONFIG_SEV', if_true: files('host-cpu.c', 'confidential-guest.c'))
+i386_ss.add(when: 'CONFIG_PKVM', if_true: files('host-cpu.c', 'confidential-guest.c'))
 
 # x86 cpu type
 i386_ss.add(when: 'CONFIG_KVM', if_true: files('host-cpu.c'))
@@ -25,6 +26,7 @@ i386_system_ss.add(files(
 ))
 i386_system_ss.add(when: 'CONFIG_SEV', if_true: files('sev.c'),
                                        if_false: files('sev-system-stub.c'))
+i386_system_ss.add(when: 'CONFIG_PKVM', if_true: files('pkvm.c'))
 
 i386_user_ss = ss.source_set()
 
diff --git a/target/i386/pkvm.c b/target/i386/pkvm.c
new file mode 100644
index 000000000000..303e25e411c5
--- /dev/null
+++ b/target/i386/pkvm.c
@@ -0,0 +1,98 @@
+/*
+ * QEMU pKVM support
+ *
+ * Copyright (C) 2025 Technology Innovation Institute
+ *
+ * This work is licensed under the terms of the GNU GPL, version 2 or later.
+ * See the COPYING file in the top-level directory.
+ */
+#include "qemu/osdep.h"
+#include "qapi/error.h"
+#include "qemu/error-report.h"
+#include <linux/kvm.h>
+
+#include "hw/i386/x86.h"
+#include "qom/object_interfaces.h"
+#include "system/system.h"
+#include "confidential-guest.h"
+
+#include "pkvm.h"
+
+#ifndef KVM_X86_PKVM_PROTECTED_VM
+#define KVM_X86_PKVM_PROTECTED_VM    28
+#endif
+
+#define TYPE_PKVM_GUEST "pkvm-guest"
+OBJECT_DECLARE_TYPE(PKVMGuest, PKVMGuestClass, PKVM_GUEST)
+
+typedef struct PKVMGuest PKVMGuest;
+typedef struct PKVMGuestClass PKVMGuestClass;
+
+/*
+ * # $QEMU \
+ *         -object pkvm-guest,id=pkvm0 \
+ *         -machine ...,confidential-guest-support=pkvm0
+ */
+struct PKVMGuest {
+    X86ConfidentialGuest parent_obj;
+};
+
+struct PKVMGuestClass {
+    X86ConfidentialGuestClass parent_class;
+};
+
+bool pkvm_enabled(void)
+{
+    ConfidentialGuestSupport *cgs = MACHINE(qdev_get_machine())->cgs;
+
+    return !!object_dynamic_cast(OBJECT(cgs), TYPE_PKVM_GUEST);
+}
+
+static int pkvm_kvm_init(ConfidentialGuestSupport *cgs, Error **errp)
+{
+    if (!should_mlock(mlock_state)) {
+        error_setg(errp, "pKVM requires '-overcommit mem-lock=on'");
+        return -1;
+    }
+
+    cgs->ready = true;
+
+    return 0;
+}
+
+static int pkvm_kvm_type(X86ConfidentialGuest *cg)
+{
+    return KVM_X86_PKVM_PROTECTED_VM;
+}
+
+static void pkvm_guest_class_init(ObjectClass *oc, const void *data)
+{
+    ConfidentialGuestSupportClass *klass = CONFIDENTIAL_GUEST_SUPPORT_CLASS(oc);
+    X86ConfidentialGuestClass *x86_klass = X86_CONFIDENTIAL_GUEST_CLASS(oc);
+
+    klass->kvm_init = pkvm_kvm_init;
+    x86_klass->kvm_type = pkvm_kvm_type;
+}
+
+static void pkvm_guest_init(Object *obj)
+{
+}
+
+static const TypeInfo pkvm_guest_info = {
+    .parent = TYPE_X86_CONFIDENTIAL_GUEST,
+    .name = TYPE_PKVM_GUEST,
+    .instance_size = sizeof(struct PKVMGuest),
+    .instance_init = pkvm_guest_init,
+    .class_init = pkvm_guest_class_init,
+    .interfaces = (const InterfaceInfo[]) {
+        { TYPE_USER_CREATABLE },
+        { }
+    }
+};
+
+static void
+pkvm_register_types(void)
+{
+    type_register_static(&pkvm_guest_info);
+}
+type_init(pkvm_register_types);
diff --git a/target/i386/pkvm.h b/target/i386/pkvm.h
new file mode 100644
index 000000000000..431ec3c63278
--- /dev/null
+++ b/target/i386/pkvm.h
@@ -0,0 +1,22 @@
+/*
+ * QEMU pKVM support
+ *
+ * Copyright (C) 2025 Technology Innovation Institute
+ *
+ * This work is licensed under the terms of the GNU GPL, version 2 or later.
+ * See the COPYING file in the top-level directory.
+ */
+#ifndef I386_PKVM_H
+#define I386_PKVM_H
+
+#ifndef CONFIG_USER_ONLY
+#include CONFIG_DEVICES /* CONFIG_PKVM */
+#endif
+
+#if !defined(CONFIG_PKVM) || defined(CONFIG_USER_ONLY)
+#define pkvm_enabled() 0
+#else
+bool pkvm_enabled(void);
+#endif
+
+#endif
-- 
2.49.0

