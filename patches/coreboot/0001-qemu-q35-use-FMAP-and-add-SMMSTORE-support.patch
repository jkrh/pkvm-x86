From 20eb4d6e6036c4323bc8683721ac44181a56beca Mon Sep 17 00:00:00 2001
From: Janne Karhunen <Janne.Karhunen@gmail.com>
Date: Thu, 4 Sep 2025 10:35:21 +0300
Subject: [PATCH] qemu/q35: use FMAP and add SMMSTORE support

Signed-off-by: Janne Karhunen <Janne.Karhunen@gmail.com>
---
 src/mainboard/emulation/qemu-q35/Kconfig  | 8 ++++++++
 src/mainboard/emulation/qemu-q35/fmap.fmd | 5 +++++
 2 files changed, 13 insertions(+)
 create mode 100644 src/mainboard/emulation/qemu-q35/fmap.fmd

diff --git a/src/mainboard/emulation/qemu-q35/Kconfig b/src/mainboard/emulation/qemu-q35/Kconfig
index 854c0533c3..9df77cccbd 100644
--- a/src/mainboard/emulation/qemu-q35/Kconfig
+++ b/src/mainboard/emulation/qemu-q35/Kconfig
@@ -20,6 +20,14 @@ config BOARD_SPECIFIC_OPTIONS
 	select BOOT_DEVICE_SUPPORTS_WRITES
 	select DRIVERS_EMULATION_QEMU_FW_CFG
 
+config USE_FMAP_FILE
+	bool
+	default y
+
+config FMDFILE
+	string
+	default "src/mainboard/emulation/qemu-q35/fmap.fmd" if USE_FMAP_FILE
+
 config VBOOT
 	select VBOOT_MUST_REQUEST_DISPLAY
 	select VBOOT_STARTS_IN_BOOTBLOCK
diff --git a/src/mainboard/emulation/qemu-q35/fmap.fmd b/src/mainboard/emulation/qemu-q35/fmap.fmd
new file mode 100644
index 0000000000..eb45981ee0
--- /dev/null
+++ b/src/mainboard/emulation/qemu-q35/fmap.fmd
@@ -0,0 +1,5 @@
+FLASH 8M {
+	FMAP 64K
+	SMMSTORE(PRESERVE) 256K
+	COREBOOT(CBFS)
+}
-- 
2.34.1

